<!DOCTYPE html>
<html>
<head>
    <title>Audio Transcriber</title>
    <link rel="stylesheet" href="/static/audio_app/style.css">
</head>
<body>
    <!-- Bot√£o de Configura√ß√µes -->
    <button id="settings-btn">‚öôÔ∏è</button>

    <!-- Modal de Configura√ß√µes de Acessibilidade -->
    <div id="settings-modal" class="modal-hidden">
        <div class="accessibility-controls">
            <h2>‚öôÔ∏è Configura√ß√µes de Acessibilidade</h2>
            <div class="control-group">
                <label for="font-size">Tamanho da Fonte:</label>
                <input type="range" id="font-size" min="1.0" max="2.0" step="0.1" value="1.0">
                <span id="font-size-value">1.0x</span>
            </div>

            <div class="control-group">
                <label for="font-family">Tipo de Fonte:</label>
                <select id="font-family">
                    <option value="Verdana, Geneva, sans-serif">Padr√£o (Verdana)</option>
                    <option value="Arial, sans-serif">Arial</option>
                    <option value="'Courier New', monospace">Monospace</option>
                    <option value="'Open Sans', sans-serif">Open Sans (Simples)</option>
                </select>
            </div>

            <div class="control-group">
                <label for="text-color">Cor do Texto:</label>
                <select id="text-color">
                    <option value="#333333">Preto (Padr√£o)</option>
                    <option value="#ffffff">Branco</option>
                    <option value="#ffff00">Amarelo</option>
                </select>
            </div>

            <div class="control-group">
                <label for="bg-color">Cor de Fundo:</label>
                <select id="bg-color">
                    <option value="transparent">Transparente (Padr√£o)</option>
                    <option value="#000000">Preto</option>
                    <option value="#ffffff">Branco</option>
                </select>
            </div>

            <div class="control-group">
                <label for="text-align">Alinhamento do Texto:</label>
                <select id="text-align">
                    <option value="left">Esquerda (Padr√£o)</option>
                    <option value="center">Centro</option>
                    <option value="right">Direita</option>
                </select>
            </div>
            <button id="close-settings-btn">Fechar</button>
        </div>
    </div>

    <div class="container">
        <h1>üé§ Audio Transcriber</h1>

        <div class="controls">
            <button id="record-btn">Iniciar Grava√ß√£o</button>
            <div id="recording-indicator"></div>
        </div>

        <div class="results">
            <div class="result-box">
                <h2>Transcri√ß√£o:</h2>
                <pre id="transcript">(O texto transcrito aparecer√° aqui)</pre>
            </div>

            <div class="result-box">
                <h2>Tradu√ß√£o:</h2>
                <pre id="translation">(A tradu√ß√£o aparecer√° aqui)</pre>
            </div>
        </div>
    </div>

    <script>
        // --- L√≥gica do Modal de Configura√ß√µes ---
        const settingsBtn = document.getElementById("settings-btn");
        const settingsModal = document.getElementById("settings-modal");
        const closeSettingsBtn = document.getElementById("close-settings-btn");

        settingsBtn.addEventListener("click", () => {
            settingsModal.classList.toggle("modal-hidden");
        });

        closeSettingsBtn.addEventListener("click", () => {
            settingsModal.classList.add("modal-hidden");
        });

        // --- L√≥gica de Acessibilidade ---

        // Vari√°veis de Acessibilidade
        const transcriptElement = document.getElementById("transcript");
        const translationElement = document.getElementById("translation");
        const fontSizeControl = document.getElementById("font-size");
        const fontSizeValue = document.getElementById("font-size-value");
        const fontFamilyControl = document.getElementById("font-family");
        const textColorControl = document.getElementById("text-color");
        const bgColorControl = document.getElementById("bg-color");
        const textAlignControl = document.getElementById("text-align");

        // Configura√ß√µes Padr√£o
        const defaultSettings = {
            fontSize: '1.0',
            fontFamily: 'Verdana, Geneva, sans-serif',
            textColor: '#333333',
            bgColor: 'transparent',
            textAlign: 'left'
        };

        function saveSettings() {
            const settings = {
                fontSize: fontSizeControl.value,
                fontFamily: fontFamilyControl.value,
                textColor: textColorControl.value,
                bgColor: bgColorControl.value,
                textAlign: textAlignControl.value
            };
            localStorage.setItem('accessibilitySettings', JSON.stringify(settings));
            applySettings(settings);
        }

        function loadSettings() {
            const savedSettings = localStorage.getItem('accessibilitySettings');
            const settings = savedSettings ? JSON.parse(savedSettings) : defaultSettings;

            // Aplicar valores aos controles
            fontSizeControl.value = settings.fontSize;
            fontFamilyControl.value = settings.fontFamily;
            textColorControl.value = settings.textColor;
            bgColorControl.value = settings.bgColor;
            textAlignControl.value = settings.textAlign;

            applySettings(settings);
        }

        function applySettings(settings) {
            // Atualizar o valor do slider
            fontSizeValue.textContent = `${settings.fontSize}x`;

            // Aplicar estilos diretamente aos elementos de transcri√ß√£o/tradu√ß√£o
            const elements = [transcriptElement, translationElement];
            elements.forEach(el => {
                el.style.fontSize = `${settings.fontSize}em`;
                el.style.fontFamily = settings.fontFamily;
                el.style.color = settings.textColor;
                el.style.backgroundColor = settings.bgColor;
                el.style.textAlign = settings.textAlign;
            });
        }

        // Event Listeners para salvar e aplicar as configura√ß√µes
        fontSizeControl.addEventListener('input', saveSettings);
        fontFamilyControl.addEventListener('change', saveSettings);
        textColorControl.addEventListener('change', saveSettings);
        bgColorControl.addEventListener('change', saveSettings);
        textAlignControl.addEventListener('change', saveSettings);

        // Carregar as configura√ß√µes ao carregar a p√°gina
        window.addEventListener('load', loadSettings);

        // --- L√≥gica de Grava√ß√£o Existente ---

        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;

        const btn = document.getElementById("record-btn");
        const indicator = document.getElementById("recording-indicator");

        // Inicializa os textos e aplica as configura√ß√µes iniciais
        transcriptElement.textContent = "(O texto transcrito aparecer√° aqui)";
        translationElement.textContent = "(A tradu√ß√£o aparecer√° aqui)";
        loadSettings(); // Garante que as configura√ß√µes s√£o aplicadas no carregamento

        btn.addEventListener("click", async () => {
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);

                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

                    mediaRecorder.onstop = sendAudio;

                    audioChunks = [];
                    mediaRecorder.start();

                    isRecording = true;
                    btn.textContent = "Parar Grava√ß√£o";
                    indicator.classList.add("active");
                    transcriptElement.textContent = "Gravando... Fale agora.";
                    translationElement.textContent = "Aguardando transcri√ß√£o...";
                } catch (error) {
                    console.error("Erro ao acessar o microfone:", error);
                    alert("N√£o foi poss√≠vel acessar o microfone. Verifique as permiss√µes.");
                }
            } else {
                mediaRecorder.stop();
                isRecording = false;
                btn.textContent = "Iniciando Processamento...";
                btn.disabled = true; // Desabilita o bot√£o durante o processamento
                indicator.classList.remove("active");
            }
        });

        function sendAudio() {
            const blob = new Blob(audioChunks, { type: "audio/wav" });
            const formData = new FormData();
            formData.append("audio", blob, "audio.wav");

            transcriptElement.textContent = "Enviando √°udio para o servidor...";
            translationElement.textContent = "Enviando √°udio para o servidor...";

            fetch("/api/transcribe/", {
                method: "POST",
                body: formData
            })
            .then(res => {
                if (!res.ok) {
                    throw new Error(`Erro HTTP: ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                transcriptElement.textContent = data.transcript || "(Nenhuma transcri√ß√£o recebida)";
                translationElement.textContent = data.translation || "(Nenhuma tradu√ß√£o recebida)";
                // Reaplicar as configura√ß√µes de acessibilidade ap√≥s a atualiza√ß√£o do conte√∫do
                applySettings(JSON.parse(localStorage.getItem('accessibilitySettings') || JSON.stringify(defaultSettings)));
            })
            .catch(err => {
                console.error("Erro:", err);
                transcriptElement.textContent = `Erro no processamento: ${err.message}`;
                translationElement.textContent = `Erro no processamento: ${err.message}`;
            })
            .finally(() => {
                btn.textContent = "Iniciar Grava√ß√£o";
                btn.disabled = false; // Reabilita o bot√£o
            });
        }
    </script>
</body>
</html>
